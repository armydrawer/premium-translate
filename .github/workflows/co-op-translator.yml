name: Co-op Translator

on:
  push:
    branches:
      - main

jobs:
  co-op-translator:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Co-op Translator
        run: |
          python -m pip install --upgrade pip
          pip install co-op-translator

      - name: Prepare limited file set for translation
        run: |
          # Create a list of files to translate (limited to 100)
          echo "Preparing file list for translation (max 100 files)..."
          
          # Find markdown files, exclude already translated directories, limit to 100
          find . -name "*.md" \
               -not -path "./translations/*" \
               -not -path "./translated_images/*" \
               -not -path "./.git/*" \
               | head -100 > files_to_translate.txt
          
          echo "Files selected for translation:"
          wc -l files_to_translate.txt
          
          # Show first few files that will be translated
          echo "First 10 files to be translated:"
          head -10 files_to_translate.txt

      - name: Run Co-op Translator
        env:
          PYTHONIOENCODING: utf-8
          # === AI Service Credentials ===
          AZURE_SUBSCRIPTION_KEY: ${{ secrets.AZURE_SUBSCRIPTION_KEY }}
          AZURE_AI_SERVICE_ENDPOINT: ${{ secrets.AZURE_AI_SERVICE_ENDPOINT }}
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_MODEL_NAME: ${{ secrets.AZURE_OPENAI_MODEL_NAME }}
          AZURE_OPENAI_CHAT_DEPLOYMENT_NAME: ${{ secrets.AZURE_OPENAI_CHAT_DEPLOYMENT_NAME }}
          AZURE_OPENAI_API_VERSION: ${{ secrets.AZURE_OPENAI_API_VERSION }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_ORG_ID: ${{ secrets.OPENAI_ORG_ID }}
          OPENAI_CHAT_MODEL_ID: ${{ secrets.OPENAI_CHAT_MODEL_ID }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
        run: |
          # =====================================================================
          # TRANSLATION WITH FILE LIMITATION
          # =====================================================================
          # Method 1: Create temporary directory with limited files
          mkdir -p temp_translation_workspace
          
          # Copy selected files to temporary workspace
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              # Create directory structure
              target_dir="temp_translation_workspace/$(dirname "$file")"
              mkdir -p "$target_dir"
              # Copy file
              cp "$file" "temp_translation_workspace/$file"
            fi
          done < files_to_translate.txt
          
          # Change to temporary workspace
          cd temp_translation_workspace
          
          # Run translation on limited file set
          translate -l "en fr" -y
          
          # Return to original directory
          cd ..

      - name: Move translations to main directory
        run: |
          # Move translated files back to main directory structure
          if [ -d "temp_translation_workspace/translations" ]; then
            echo "Moving translated files..."
            cp -r temp_translation_workspace/translations/ ./
          fi
          
          if [ -d "temp_translation_workspace/translated_images" ]; then
            echo "Moving translated images..."
            cp -r temp_translation_workspace/translated_images/ ./
          fi
          
          # Clean up temporary workspace
          rm -rf temp_translation_workspace
          rm -f files_to_translate.txt
          
          # Show what was created
          echo "Translation results:"
          if [ -d "translations" ]; then
            find translations -name "*.md" | wc -l
            echo "translated markdown files created"
          fi

      - name: Create Pull Request with translations
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "🌐 Update translations via Co-op Translator (limited to 100 files)"
          title: "🌐 Update translations via Co-op Translator (limited to 100 files)"
          body: |
            This PR updates translations for recent changes to the main branch.
            
            ### 📋 Changes included
            - Translated contents are available in the `translations/` directory
            - Translated images are available in the `translated_images/` directory
            - **Limited to maximum 100 markdown files** to control translation scope and costs
            
            ### 🔧 Translation Details
            - Only the first 100 `.md` files found in the repository were processed
            - Excluded files in `translations/` and `translated_images/` directories
            - Excluded `.git/` directory files

            ---
            🌐 Automatically generated by the [Co-op Translator](https://github.com/Azure/co-op-translator) GitHub Action.
          branch: update-translations
          base: main
          delete-branch: true
          add-paths: |
            translations/
            translated_images/
