name: ðŸ“– Translate Documentation (RU â†’ EN)

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'ru/**/*.md'
      - 'translations/**'
  
  workflow_dispatch:
    inputs:
      force_translate:
        description: 'Force retranslation of all files'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  pull-requests: write

jobs:
  prepare-translations:
    name: ðŸ”„ Prepare translation files
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: ðŸ“¦ Install dependencies
        run: |
          pip install pyyaml frontmatter markdown
          
      - name: ðŸ” Extract translatable content from Markdown
        run: |
          mkdir -p translations/ru translations/en
          python scripts/extract-content.py
          
      - name: ðŸ“¤ Upload translation files
        run: |
          # Ð—Ð´ÐµÑÑŒ SimpleLocalize GitHub App Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿Ð¾Ð´Ñ…Ð²Ð°Ñ‚Ð¸Ñ‚ Ñ„Ð°Ð¹Ð»Ñ‹
          # ÑÐ¾Ð³Ð»Ð°ÑÐ½Ð¾ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ð² simplelocalize.yml
          echo "Translation files prepared for SimpleLocalize"
          ls -la translations/
          
      - name: ðŸ’¾ Commit extracted content
        if: github.event.inputs.force_translate == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add translations/
          git diff --staged --quiet || git commit -m "ðŸ”„ Extract translatable content from Russian docs"
          git push

  process-translations:
    name: ðŸŒ Process translated content
    runs-on: ubuntu-latest
    needs: prepare-translations
    # Ð­Ñ‚Ð¾Ñ‚ job Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑÑ Ð¿Ð¾ÑÐ»Ðµ Ñ‚Ð¾Ð³Ð¾, ÐºÐ°Ðº SimpleLocalize ÑÐ¾Ð·Ð´Ð°ÑÑ‚ PR Ñ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð°Ð¼Ð¸
    if: github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'auto-generated')
    
    steps:
      - name: ðŸ“¥ Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          
      - name: ðŸ Set up Python  
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: ðŸ“¦ Install dependencies
        run: |
          pip install pyyaml frontmatter markdown
          
      - name: ðŸ”¨ Build English markdown files
        run: |
          mkdir -p en
          python scripts/build-markdown.py
          
      - name: ðŸ–¼ï¸ Copy and process images
        run: |
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð¸Ð· ru/ Ð² en/
          find ru -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" -o -name "*.svg" | while read img; do
            en_img=$(echo "$img" | sed 's|^ru/|en/|')
            mkdir -p "$(dirname "$en_img")"
            cp "$img" "$en_img"
            echo "Copied: $img â†’ $en_img"
          done
          
      - name: âœ¨ Update image references in English docs
        run: |
          # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¿ÑƒÑ‚Ð¸ Ðº Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸ÑÐ¼ Ð² Ð°Ð½Ð³Ð»Ð¸Ð¹ÑÐºÐ¸Ñ… Ñ„Ð°Ð¹Ð»Ð°Ñ…
          find en -name "*.md" -exec sed -i 's|/ru/|/en/|g; s|(ru/|(en/|g' {} \;
          
      - name: ðŸ“ Generate translation report
        run: |
          python scripts/generate-report.py > translation-report.md
          
      - name: ðŸ’¾ Commit processed files
        run: |
          git config --local user.email "action@github.com" 
          git config --local user.name "GitHub Action"
          git add en/ translation-report.md
          git diff --staged --quiet || git commit -m "ðŸŒ Build English documentation from translations
          
          - Generated English markdown files from JSON translations
          - Copied and updated image references  
          - Created translation report"
          git push

  validate-translations:
    name: âœ… Validate translations
    runs-on: ubuntu-latest
    needs: process-translations
    if: always()
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ðŸ” Check file structure
        run: |
          echo "ðŸ“‹ Checking English documentation structure..."
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° en/ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ ru/
          find ru -name "*.md" | while read ru_file; do
            en_file=$(echo "$ru_file" | sed 's|^ru/|en/|')
            if [ ! -f "$en_file" ]; then
              echo "âŒ Missing: $en_file"
              exit 1
            else
              echo "âœ… Found: $en_file"
            fi
          done
          
      - name: ðŸ–¼ï¸ Validate images
        run: |
          echo "ðŸ–¼ï¸ Checking image references..."
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð²ÑÐµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹
          find ru -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" -o -name "*.svg" | while read ru_img; do
            en_img=$(echo "$ru_img" | sed 's|^ru/|en/|')
            if [ ! -f "$en_img" ]; then
              echo "âŒ Missing image: $en_img"
              exit 1
            else
              echo "âœ… Found image: $en_img"
            fi
          done
          
      - name: ðŸ“Š Generate summary
        if: always()
        run: |
          echo "## ðŸ“Š Translation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Russian files**: $(find ru -name "*.md" | wc -l)" >> $GITHUB_STEP_SUMMARY  
          echo "- **English files**: $(find en -name "*.md" 2>/dev/null | wc -l || echo 0)" >> $GITHUB_STEP_SUMMARY
          echo "- **Images copied**: $(find en -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" -o -name "*.svg" 2>/dev/null | wc -l || echo 0)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ **Status**: $([ -d "en" ] && echo "âœ… Complete" || echo "â³ In Progress")" >> $GITHUB_STEP_SUMMARY
