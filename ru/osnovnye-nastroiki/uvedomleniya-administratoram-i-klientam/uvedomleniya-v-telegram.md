---
description: >-
  Оповещения в Telegram нужны для уведомления администраторов и пользователей об
  изменениях статусов заявок или других запросах без необходимости держать
  открытой страницу обменника.
---

# Уведомления в Telegram

{% hint style="warning" %}
Вы находитесь в инструкции для создания телеграм-бота для уведомлений клиентов по заявкам — если же вам нужна инструкция для создания бота для обмена, воспользуйтесь [инструкцией](https://premium.gitbook.io/main/osnovnye-nastroiki/telegram-bot-dlya-obmena) для другого раздела.
{% endhint %}

{% hint style="warning" %}
Для корректной работы бота уведомлений требуется:

* У пользователя должен быть добавлен юзернейм из Телеграм в ЛК в вашем обменнике
* Пользователь должен активировать вашего бота для уведомлений командой `/start` и получить от него ответ
{% endhint %}

## Настройки

1. В Telegram отправьте пользователю [@BotFather](https://t.me/BotFather) сообщение **/newbot** и следуйте инструкциям по созданию бота. После успешного создания бота, отобразится token - скопируйте его в буфер обмена. Другие настройки бота изменять не нужно.
2. В панели управления сайтом (раздел "**Telegram**" -> "**Настройки**") в поле "**Token**" укажите токен, который был получен во время создания бота.&#x20;

<figure><img src="../../.gitbook/assets/image (966).png" alt=""><figcaption><p>Раздел "<strong>Telegram</strong>" -> "<strong>Настройки</strong>"</p></figcaption></figure>

{% hint style="info" %}
Если раздел Telegram не отображается в боковой панели - включите модуль в разделе "Модули":

![](<../../.gitbook/assets/image (863).png>)
{% endhint %}

3. При необходимости логирования действий бота и последующего просмотра логов в разделе "**Telegram**" -> "**Лог сообщений**", активируйте следующие опции

<figure><img src="../../.gitbook/assets/image (886).png" alt=""><figcaption><p>Раздел "<strong>Telegram</strong>" -> "<strong>Лог сообщений</strong>"</p></figcaption></figure>

4. В нижней части раздела "**Telegram**" -> "**Настройки**" перейдите по ссылке для регистрации вебхука.

<figure><img src="../../.gitbook/assets/image (865).png" alt=""><figcaption><p>Раздел "<strong>Telegram</strong>" -> "<strong>Настройки</strong>"</p></figcaption></figure>

5. При необходимости пропишите текст сообщений для пользователей бота.

<figure><img src="../../.gitbook/assets/image (1234).png" alt=""><figcaption><p>Раздел "<strong>Telegram</strong>" -> "<strong>Настройки</strong>"</p></figcaption></figure>

6. В разделе "**Пользователи**" в профиле вашего пользователя укажите ваш Username из Telegram без @ (если Username отсутствует, то его необходимо задать в настройках Telegram)

<figure><img src="../../.gitbook/assets/image (1164).png" alt=""><figcaption><p>Раздел "<strong>Настройки</strong>" в Telegram</p></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (1241).png" alt=""><figcaption><p>Раздел "<strong>Пользователи</strong>" -> "<strong>Редактировать</strong>"</p></figcaption></figure>

7. Активируйте бота, отправив ему сообщение **/start** в Telegram.
8. В разделе "**Сообщения" → "Тelegram шаблоны"** настройте необходимые шаблоны для различных статусов заявок и других опций для отправления сообщений от имени бота администраторам и пользователям:

{% hint style="warning" %}
Обратите внимание, что настройки для администраторов и пользователей в выпадающем списке являются отдельными сущностями и настраиваются независимо друг от друга
{% endhint %}

<figure><img src="../../.gitbook/assets/image (1093).png" alt=""><figcaption><p>Раздел "<strong>Сообщения" → "Тelegram шаблоны"</strong> </p></figcaption></figure>

Настройки шаблона:

* **Отправлять**: "Да" — отправляем сообщения, "Нет" — не отправляем.
* **Telegram username администратора (без @)** — username администратора, на который он будет получать уведомления. Через запятую можно указать несколько username, если у вас несколько администраторов.
* **Текст** — текст отправляемого сообщения. Над полем для ввода текст, вы найдете панель с \[шорт-кодами]. Используйте их в тексте письма и в заголовке письма, чтобы в отправляемых сообщениях отображались данные из заявок.

9. Для того, чтобы использовать бота, необходимо добавить дополнительное поле "Телеграм"[^1] в каждое направление обмена, которое будет использовать бота.

<figure><img src="../../.gitbook/assets/image (1242).png" alt=""><figcaption><p>Раздел "<strong>Направления обменов</strong>" -> "<strong>Доп. поля</strong>"</p></figcaption></figure>

Это необходимо для того, чтобы на странице обменника в направлениях обмена отображалось поле для ввода Username пользователем обменника

<figure><img src="../../.gitbook/assets/image (962).png" alt=""><figcaption><p>Страница обмена</p></figcaption></figure>

10. Для того, что использовать бота, пользователь обменника может указать свой Username в Telegram в настройках профиля (при этом он будет автоматически подставляться в поле "Телеграм", если оно будет присутствовать при создании заявки (набор полей определяется администратором для каждого направления индивидуально)) или при создании каждой заявки указывать Username вручную.

<figure><img src="../../.gitbook/assets/image (1039).png" alt=""><figcaption><p>Личный кабинет пользователя в обменнике</p></figcaption></figure>

{% hint style="info" %}
По умолчанию администраторам сообщения не отправляются, если администратор сам меняет статус заявки в админке (раздел "**Заявки**") - если вам необходимо, чтобы сообщения всегда отправлялись администратору, эту опцию необходимо активировать в разделе "**Настройки обменника**" -> "**Основные настройки**" -> "**Другие настройки**", пункт "Отправлять email админу, если админ сам меняет статус заявки".

<img src="../../.gitbook/assets/image (938).png" alt="" data-size="original">
{% endhint %}

{% hint style="warning" %}
Для того, чтобы получать уведомления в Telegram - каждому пользователя **обязательно** нужно "стартовать" бота на своём аккаунте
{% endhint %}

## Диагностика неисправностей

Если пользователям или администраторам не приходят или перестали приходить сообщения от бота - загляните в раздел "**Telegram**" -> "**Лог сообщений**", где можно просмотреть все логи, относящиеся к работе бота. При необходимости вы можете воспользоваться фильтром, который показывает какие сообщения относятся к самому боту, а какие к пользователям бота.

<figure><img src="../../.gitbook/assets/image (1158).png" alt=""><figcaption><p>Раздел "<strong>Telegram</strong>" -> "<strong>Лог сообщений</strong>"</p></figcaption></figure>

При неполадках с отправкой сообщений с помощью бота, вы можете удалить и зарегистрировать заново вебхук (см. п. 4) - это может помочь восстановить работу бота.

Если вы используете Cloudflare или подобный сервис для своего сайта - добавьте [IP-адреса Telegram](https://core.telegram.org/resources/cidr.txt) в whitelist в вашем сервисе:

```
91.108.56.0/22
91.108.4.0/22
91.108.8.0/22
91.108.16.0/22
91.108.12.0/22
149.154.160.0/20
91.105.192.0/23
91.108.20.0/22
185.76.151.0/24
2001:b28:f23d::/48
2001:b28:f23f::/48
2001:67c:4e8::/48
2001:b28:f23c::/48
2a0a:f280::/32
```

Альтернативный вариант: добавление пула IP-адресов по ASN (autonomous system number) — ASN Telegram и их добавление в whitelist в ЛК Cloudflare указаны в [инструкции](https://premium.gitbook.io/main/osnovnye-nastroiki/faq/dobavlenie-ip-adresov-v-whitelist-v-cloudflare).

[^1]: (название можно поменять в настройках обменника)
