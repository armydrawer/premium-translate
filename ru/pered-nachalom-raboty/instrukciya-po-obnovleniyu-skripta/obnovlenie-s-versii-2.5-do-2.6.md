# Обновление с версии 2.5 до 2.6

{% embed url="https://www.youtube.com/watch?v=XX2Wpv-dAFk" %}
Видеоинструкция по обновлению скрипта
{% endembed %}

{% hint style="success" %}
Список обновлений скрипта для версии 2.6 доступен по [**ссылке**](https://premium.gitbook.io/main/pered-nachalom-raboty/instrukciya-po-obnovleniyu-skripta/spisok-obnovlenii#versiya-2.6)
{% endhint %}

{% hint style="warning" %}
Перед началом обновление скрипта, выполните обновление на сервере Ioncube Loader до версии 13.0 и выше (если установленная версия ниже 13 — [**инструкция по проверке установленной версии**](https://premium.gitbook.io/main/osnovnye-nastroiki/faq/kak-proverit-versiyu-ioncube-ustanovlennuyu-na-servere)**,** [**инструкция по обновлению**](https://premium.gitbook.io/main/osnovnye-nastroiki/faq/kak-obnovit-ioncube-loader)). В обновлении поможет техническая поддержка вашего хостинга.
{% endhint %}

{% hint style="warning" %}
Начиная с версии 2.6 из соображений безопасности убрана поддержка **PHP 7.1, 7.2, 7.3**, **7.4** и добавлена поддержка **PHP 8.2** - если в версии 2.5 вы использовали версию **PHP 7.4** и ниже, перед обновлением скрипта необходимо обновить версию PHP на сервере. Рекомендуем провести обновление PHP через техподдержку вашего хостинга.

[**Инструкция по проверке версии PHP, установленной на сервере**](https://premium.gitbook.io/main/osnovnye-nastroiki/faq/kak-proverit-versiyu-php-ustanovlennuyu-na-servere)
{% endhint %}

{% hint style="warning" %}
Если вы используете модули мерчантов и автовыплат, разработанными нами персонально для вас **—** запросите обновленные модули в вашей группе в Телеграм (**не в технической поддержке через бота**).

Если вы используете модули мерчантов и автовыплат, а также другие типы модулей от сторонних разработчиков, то они не будут работать на версии 2.6 без их обновления со стороны разработчиков.
{% endhint %}

{% hint style="warning" %}
Если вы использовали модули Electrum и/или "Торговые действия" в версии 2.5 **—** запросите модули под версию 2.6 в вашей группе в Телеграм (**не в технической поддержке через бота**)
{% endhint %}

{% hint style="danger" %}
<mark style="color:red;">**Перед обновлением обязательно сделайте резервную копию сайта и базы данных!**</mark>

В случае, если во время обновления что-то пойдет не так, вы всегда сможете восстановить сайт из резервной копии. Способы резервного копирования могут отличаться в зависимости от хостинга, поэтому вам стоит обратиться в техническую поддержку вашего хостинга с данным вопросом.

Самый простой способ [**сделать резервную копию сайта**](https://premium.gitbook.io/main/osnovnye-nastroiki/faq/kak-sdelat-bekap-saita) — через панель управления сервером (ISP Manager или другое ПО) с помощью встроенного в панель файлового менеджера или через FTP-клиент (скачайте на компьютер файлы сайта, а также в разделе управления базами данных или через PhpMyAdmin скачайте БД сайта).
{% endhint %}

{% hint style="warning" %}
**Обратите внимание — при обновления скрипта с версии 2.5 на 2.6 требуется обновление (бесплатное) кастомных тем для сайта!**

Если вы используете такую тему — пришлите архив с ней для адаптации под версию 2.6.\
Для этого перейдите на сервере в папку по пути `www/<имя_сайта>/wp-content/themes/`, найдите папку с вашей темой, заархивируйте её, скачайте на компьютер, а затем пришлите архив в вашей группе в Телеграм.&#x20;
{% endhint %}

1.  В панели управления обменником в разделе "**Консоль**" включите технический режим работы обменника, чтобы пользователи обменника не совершали заявки на сайте во время обновления скрипта.

    <figure><img src="../../.gitbook/assets/image (879).png" alt=""><figcaption></figcaption></figure>
2.  В разделе "**Плагины**" деактивируйте плагины "**Premium Exchanger**" и "**Premium Exchanger hooks**".

    <figure><img src="../../.gitbook/assets/image (1169).png" alt=""><figcaption></figcaption></figure>
3. С помощью FTP-клиента или файлового менеджера удалите на сервере содержимое папки **`/wp-content/plugins/premiumbox/`**, <mark style="color:green;">**кроме**</mark> следующих файлов и папок внутри неё:

* **`/flags/`**
* **`/languages/`**
* **`/moduls/`**(но сперва ознакомьтесь с текстом в блоке ниже)

{% hint style="danger" %}
- Если вы **используете** [**внутренние счета**](https://premium.gitbook.io/main/osnovnye-nastroiki/nastroiki/vnutrennie-scheta/obmen-s-uchastiem-vnutrennego-scheta-polzovatelya) — не удаляйте папку **domacc** внутри папки **`moduls`**
- Если вы **не используете** внутренние счета — можете удалить папку **`moduls`** целиком.

\
После обновления скрипта необходимо провести перенос внутренних счетов в новый модуль — [**инструкция по переносу**](https://premium.gitbook.io/main/pered-nachalom-raboty/instrukciya-po-obnovleniyu-skripta/obnovlenie-s-versii-2.5-do-2.6#id-2.-obnovlenie-modulya-vnutrennii-schyot-tolko-esli-vnutrennie-scheta-ispolzovalis-v-versii-2.5-.-esl) **(актуально, только если вы использовали внутренние счета в 2.5)**

* Если вы **используете** модуль Webmoney, не удаляйте папку **`x19`** внутри папки **`moduls`**
* Если вы **не используете** модуль Webmoney — можете удалить папку **`moduls`** целиком
{% endhint %}

* **`/sms/`**
* **`/userdata.php`**

<figure><img src="../../.gitbook/assets/image (1775).png" alt="" width="563"><figcaption><p><strong>Удалите все отмеченные галочкой файлы и папки на своём сервере</strong></p></figcaption></figure>

4.  Удалите все файлы предыдущей лицензии из корневой папки сайта.\


    <figure><img src="../../.gitbook/assets/image (1774).png" alt="" width="432"><figcaption></figcaption></figure>

Перейдите в раздел "[**Ваши лицензии**](https://premiumexchanger.com/ulicense/)" и скачайте архив с файлами лицензии `license.zip`. Для этого нажмите на ссылку "**Скачать для версии 2.6**".

<figure><img src="../../.gitbook/assets/image (473).png" alt="" width="485"><figcaption></figcaption></figure>

Скачанный архив загрузите в [корневую папку вашего сайта](https://premium.gitbook.io/main/osnovnye-nastroiki/faq/kak-naiti-kornevuyu-papku-saita-na-servere) под <mark style="color:green;">**пользователем, созданным для сайта**</mark> (не <mark style="color:red;">**root**</mark>!) и **обязательно** распакуйте архив.

{% hint style="danger" %}
**Выполните шаг 4 в обязательном порядке, даже если файлы лицензии были ранее загружены на сервер — в противном случае сайт не будет работать!**
{% endhint %}

5. Перейдите в раздел "[**Ваши скрипты**](https://premiumexchanger.com/uscripts/)" и на странице скачайте архив с **файлами для обновления версии 2.6** под вашу версию PHP.

{% hint style="danger" %}
Необходимо точно знать версию PHP, установленную на вашем сервере, для выбора подходящего архива.\
[**Инструкция по проверке версии PHP, установленной на сервере**](https://premium.gitbook.io/main/osnovnye-nastroiki/faq/kak-proverit-versiyu-php-ustanovlennuyu-na-servere)
{% endhint %}

<figure><img src="../../.gitbook/assets/image (472).png" alt="" width="563"><figcaption></figcaption></figure>

6. Загрузите содержимое архива с обновлением в корневую папку вашего сайта под <mark style="color:green;">**пользователем, созданным для сайта**</mark> (не <mark style="color:red;">**root**</mark>!). Используйте FTP-клиент, либо файловый менеджер. Распакуйте архив с заменой файлов.
7. Перейдите в раздел "**Плагины**" и активируйте плагины "**Premium Exchanger"** и "**Premium Exchanger hooks**".
8. Перейдите в раздел **Настройки обменника" → "Миграция"** и в блоке "**Миграция (если версия меньше 2.6)**" поочередно выполните каждый шаг.

<figure><img src="../../.gitbook/assets/image (1682).png" alt="" width="390"><figcaption></figcaption></figure>

При запуске каждого шага система определит общее количество запросов, которые нужно выполнить. У вас есть возможность задать количество запросов, которое будет обработано за один цикл.

<figure><img src="../../.gitbook/assets/image (500).png" alt="" width="345"><figcaption></figcaption></figure>

{% hint style="warning" %}
По умолчанию количество запросов = 50. Если вы не уверены в мощности вашего сервера, то рекомендуем не менять значение по умолчанию.

При необходимости вы можете указать любое другое значение, но если выполнение цикла с указанным значением окажется слишком ресурсоемким для сервера — это вызовет ошибку.
{% endhint %}

{% hint style="info" %}
Вы можете увидеть кнопки "**Технический шаг X**" рядом с кнопками "**Шаг X**". Перед выполнением каждого шага, система определяется количество запросов, которые необходимо выполнить. В некоторых случаях количество запросов может быть слишком велико и сервер может не справиться с их подсчетом. В этом случае вместо кнопки "**Шаг X**" стоит использовать кнопку "**Технический шаг X**", которая позволяет задавать произвольное количество запросов вручную без подсчета количества запросов сервером.

Если вы используете **технический шаг**, то вам необходимо задать вручную количество запросов. Рекомендуем установить заведомо большое число, например, 100000.
{% endhint %}

9. Перейдите в раздел "**Настройки" → "Постоянные ссылки"** и нажмите на кнопку "**Сохранить изменения**", не внося никаких изменений на странице.
10. Перейдите в раздел "**Настройки обменника" → "Основные настройки"** и отключите режим обновления.

<figure><img src="../../.gitbook/assets/image (1729).png" alt=""><figcaption></figcaption></figure>

Альтернативный вариант — в этом же разделе для параметра "**Режим обновления**" выберите "**Нет**" и сохраните изменения.

<figure><img src="../../.gitbook/assets/image (474).png" alt="" width="255"><figcaption></figcaption></figure>

{% hint style="warning" %}
Режим обновления активируется каждый раз после деактивации и повторной активации основного плагина, поэтому режим всегда необходимо отключать вручную.
{% endhint %}

11. Если вы используете модули "**Парсеры 2.0**" или "**Bestchange парсер**" — после отключения режима обновления необходимо запустить работу парсеров в соответствующих разделах, вручную переходом по ссылке Сron.\
    Для работы Парсеров 2.0:

    <figure><img src="../../.gitbook/assets/image (394).png" alt=""><figcaption></figcaption></figure>

    Для работы BestChange парсера:

    <figure><img src="../../.gitbook/assets/image (392).png" alt="" width="563"><figcaption></figcaption></figure>
12. [Очистите кэш в браузере](https://www.unisender.com/ru/blog/kak-ochistit-kehsh-v-brauzerah/).\


    <figure><img src="../../.gitbook/assets/image (395).png" alt="" width="563"><figcaption></figcaption></figure>
13. <mark style="color:red;">**Обязательно удалите из корневой папки на сервере любые загруженные zip-архивы скрипта и бэкапы сайта.**</mark>\


    <figure><img src="../../.gitbook/assets/image (396).png" alt="" width="563"><figcaption></figcaption></figure>
14. Отключите режим технического обслуживания в разделе "**Консоль**".
15. <mark style="color:green;">**Обновление успешно проведено!**</mark>

### Изменения в панели администратора

После обновления необходимо внести изменения в панели администратора для корректной работы скрипта.

1. Для работы подтверждения регистрации через e-mail необходимо включить модуль "**Подтверждение e-mail перед регистрацией**" (**confirmregmail**) в разделе "**Модули**". Если вы не используете эту опцию  — можете оставить модуль выключенным.

<details>

<summary>2. Обновление модуля "<strong>Внутренний счёт</strong>" (только если <a href="https://premium.gitbook.io/main/osnovnye-nastroiki/nastroiki/vnutrennie-scheta/obmen-s-uchastiem-vnutrennego-scheta-polzovatelya">внутренние счета</a> использовались в версии 2.5!).<br><br>Если вы не использовали внутренние счета ранее и хотите использовать их в версии 2.6 — пропустите этот шаг. Активируйте модуль iac в разделе "<strong>Модули</strong>" и настройте его по <a href="https://premium.gitbook.io/main/osnovnye-nastroiki/nastroiki/vnutrennie-scheta">инструкции</a>.</summary>

Если вы используете модуль **"Внутренний счет" (domacc)**, а также модули мерчанта на приём и автовыплаты **domacc**:

![](<../../.gitbook/assets/image (1644).png>)![](<../../.gitbook/assets/image (1645).png>)

<mark style="color:red;">**необходимо**</mark> перейти на новый модуль **"Модуль внутреннего счета" (iac)**.

Инструкция по переходу на новый модуль:

* Активируйте новый модуль **iac** в разделе "**Модули**" (модуль **domacc** также **должен быть включен** для успешной миграции)
* Последовательно выполните миграцию — шаг 7 и шаг 8 в разделе "**Настройки обменника**" -> "**Миграция**"

![](<../../.gitbook/assets/image (1646).png>)

![](<../../.gitbook/assets/image (1647).png>)![](<../../.gitbook/assets/image (1648).png>)

* Отключите старый модуль **domacc** в разделе **"Модули"**, а затем удалите модуль с сервера (путь к папке с модулем —  `wp-content/plugins/premiumbox/moduls/domacc)`\
  ![](<../../.gitbook/assets/image (1649).png>)
* Удалите модули мерчанта и автовыплаты **domacc** в панели администратора в разделах **"Мерчанты" -> "Мерчанты"** и **"Мерчанты" -> "Автовыплаты"**, затем удалите модули с сервера (пути к папкам с модулями — `wp-content/plugins/premiumbox/moduls/merchants/domacc` и `wp-content/plugins/premiumbox/moduls/paymerchants/domacc`)
* Добавьте нового мерчанта и автовыплату **iac** в разделах **"Мерчанты" -> "Мерчанты" "Мерчанты" -> "Автовыплаты"** и настройте их по [инструкции](https://premium.gitbook.io/main/osnovnye-nastroiki/nastroiki/vnutrennie-scheta).
* &#x20;Созданных мерчантов добавьте в подходящие для этого направления обменов (вкладка "**Мерчанты и выплаты**" в настройках направлений обменов)

![](<../../.gitbook/assets/image (463).png>)

<mark style="color:red;">**Важно!**</mark> Если при использовании модулей мерчанта на приём и автовыплаты для работы с внутренними счётами в форме обмена не будет указан номер внутреннего счёта для списания и/или зачисления средств, он будет равным **`код валюты + id клиента`** из профиля клиента (раздел "**Личные данные**" -> "**Внутренний счёт**")

![](<../../.gitbook/assets/image (1655).png>)![](<../../.gitbook/assets/image (1654).png>)

Если счёт будет указан в форме обмена, то именно он будет использоваться для списания/зачисления (обратите внимание, что таким образом возможно переводить валюту на счёт другого пользователя обменника, если известен его ID).

![](<../../.gitbook/assets/image (1656).png>)

Продолжите обновление скрипта.

</details>

3. Начиная с версии 2.6, модуль **"Капча для сайта (выбор картинки)" (sitecaptcha\_img)** самостоятельно генерирует варианты для выбора пользователем на сайте. В предыдущей версии модуля можно было создавать свои задания, начиная с версии 2.6 эта опция отключена, поэтому изменения во внешнем виде капчи сразу отобразятся на сайте.
4. После обновления в разделе "**Настройки обменника**" -> "**Основные настройки**" <mark style="color:red;">**обязательно**</mark> выберите логику работы с заявками при использовании мерчантов на приём для опции "**Действие, если мерчант не сработал**".\
   Подробнее о работе этой опции читайте в инструкции "[**Общие настройки мерчантов**](https://premium.gitbook.io/main/osnovnye-nastroiki/merchanty-i-avtovyplaty/merchanty/obshie-nastroiki-merchantov#podklyuchenie-neskolkikh-merchantov)".
